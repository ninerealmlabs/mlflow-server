---
name: docker-build-CI

on:
  push:
    branches:
      # - main
      - develop/**
    paths:
      - docker
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:
      - main
    paths:
      - docker
  workflow_dispatch:

# yamllint disable rule:colons
env: # define 'static' vars here
  platforms:   "linux/amd64,linux/arm64"
  gh_registry: ghcr.io/ninerealmlabs
  # d_registry:  docker.io/ninerealmlabs
  owner:       ninerealmlabs

jobs:
  # "Any environment variables set in an env context defined at the workflow level in the caller workflow
  #  are NOT propagated to the called workflow"
  export-envs:
    # runs-on: self-hosted
    runs-on: ubuntu-latest
    outputs:
      platforms:   ${{ env.platforms }}
      gh_registry: ${{ env.gh_registry }}
      # d_registry:  ${{ env.d_registry }}
      owner:       ${{ env.owner }}
    steps:
      - run: echo "Exposing env vars to downstream jobs ðŸ“¬"

  build:
    needs: [export-envs]
    uses: ./.github/workflows/2-build-test-tag.yaml
    with:
      source_image:   jupyter/minimal-notebook                    # <-- UPDATE ###
      # source_tag:     latest                                    # <-- UPDATE ###
      # source_digest:  ''                                        # <-- UPDATE ###
      image_name:     base-env                                    # <-- UPDATE ###
      python_version: ${{ inputs.python_version }}
      platforms:      ${{ inputs.platforms }}
      gh_registry:    ${{ inputs.gh_registry }}
      # d_registry:     ${{ inputs.d_registry }}
      owner:          ${{ inputs.owner }}
    secrets: inherit
